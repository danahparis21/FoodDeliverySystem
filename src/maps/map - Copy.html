<!DOCTYPE html>
<html>
  <head>
    <title>Choose Address</title>
    <script>
      let map;
      let geocoder;
      let infowindow;
      let marker;

      function initMap() {
        geocoder = new google.maps.Geocoder();
        infowindow = new google.maps.InfoWindow();

        const defaultLatLng = { lat: 14.072479, lng: 120.632137}; 

        map = new google.maps.Map(document.getElementById('map'), {
          center: defaultLatLng,
          zoom: 16  // Increased zoom level for a closer view
        });

        // Add a click listener to the map
        map.addListener('click', function (e) {
          placeMarkerAndReverseGeocode(e.latLng);
        });
      }

      // In your placeMarkerAndReverseGeocode function:
function placeMarkerAndReverseGeocode(latLng) {
    console.log("âœ… Clicked at:", latLng.lat(), latLng.lng());

    if (marker) {
        marker.setPosition(latLng);
    } else {
        marker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: "Selected Location"
        });
    }

    // Show loading indicator
    infowindow.setContent("Loading address...");
    infowindow.open(map, marker);

    // Reverse geocode the latLng to get the address
    geocoder.geocode({ 'location': latLng }, function (results, status) {
        console.log("ðŸŸ¡ Geocode response:", status, results);

        if (status === 'OK' && results.length > 0) {
            console.log("ðŸŸ¢ Geocode SUCCESS:", results[0].formatted_address);

            const addressComponents = results[0].address_components;
           console.log("ðŸŸ£ Address Components: ", addressComponents.map(c => ({ type: c.types[0], value: c.long_name })));


            const street = addressComponents.find(c => c.types.includes("route"))?.long_name || "N/A";
            const city = addressComponents.find(c => c.types.includes("locality"))?.long_name || "N/A";
            const postalCode = addressComponents.find(c => c.types.includes("postal_code"))?.long_name || "N/A";
            const country = addressComponents.find(c => c.types.includes("country"))?.long_name || "N/A";

            console.log("ðŸ”µ Extracted Address:", { street, city, postalCode, country });

            infowindow.setContent(results[0].formatted_address);
            infowindow.open(map, marker);

            // Call Java Bridge
          if (typeof window.addressBridge !== 'undefined') {
    console.log("ðŸŸ  Sending to Java Bridge:", street, city, postalCode, country);
    window.addressBridge.updateAddress(street, city, postalCode, country);
} else {
    console.error("ðŸ”´ Address bridge is undefined!");
}

        } else {
            console.error("ðŸ”´ Geocoder failed due to:", status);
        }
    });
}

    </script>
    <!-- Google Maps API call with dynamically injected API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbspm2lyNyjbOfakcXK-VsXo4pAfGt1vA&callback=initMap&libraries=places" async defer></script>  
  </head>
  <body>
    <div id="map" style="height: 500px; width: 100%;"></div>
  </body>
</html>
